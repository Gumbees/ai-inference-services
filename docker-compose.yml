services:
  faster-whisper:
    image: onerahmet/openai-whisper-asr-webservice:latest
    expose:
      - "9000"
    environment:
      - ASR_MODEL=base
      - PORT=9000
    volumes:
      - whisper_models:/root/.cache/whisper
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      # Public Domain
      - "traefik.http.routers.whisper-public.rule=Host(`${WHISPER_PUBLIC_DOMAIN}`)"
      - "traefik.http.routers.whisper-public.entrypoints=websecure"
      - "traefik.http.routers.whisper-public.tls.certresolver=letsencrypt"
      # Private Domain
      - "traefik.http.routers.whisper-private.rule=Host(`${WHISPER_PRIVATE_DOMAIN}`)"
      - "traefik.http.routers.whisper-private.entrypoints=websecure"
      - "traefik.http.routers.whisper-private.tls.certresolver=letsencrypt"
      # Service configuration
      - "traefik.http.services.whisper.loadbalancer.server.port=9000"
      - "traefik.docker.network=traefik_public"
    networks:
      ai-app:
      traefik_public:
      dmz:
        ipv4_address: 192.168.73.90

  ollama:
    image: ollama/ollama:rocm
    runtime: amd
    expose:
      - "11434"
    environment:
      - OLLAMA_HOST=0.0.0.0
      - AMD_VISIBLE_DEVICES=all
    volumes:
      - ollama_data:/root/.ollama
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '8'
    labels:
      - "traefik.enable=true"
      # Public Domain
      - "traefik.http.routers.ollama-public.rule=Host(`${OLLAMA_PUBLIC_DOMAIN}`)"
      - "traefik.http.routers.ollama-public.entrypoints=websecure"
      - "traefik.http.routers.ollama-public.tls.certresolver=letsencrypt"
      # Private Domain
      - "traefik.http.routers.ollama-private.rule=Host(`${OLLAMA_PRIVATE_DOMAIN}`)"
      - "traefik.http.routers.ollama-private.entrypoints=websecure"
      - "traefik.http.routers.ollama-private.tls.certresolver=letsencrypt"
      # Service discovery
      - "traefik.http.services.ollama.loadbalancer.server.port=11434"
      - "traefik.docker.network=traefik_public"
    networks:
      - ai-app
      - traefik_public

  # ============================================
  # Hindsight - AI Memory Layer
  # ============================================
  # Vectorize Hindsight with embedded PostgreSQL
  # GitHub: https://github.com/vectorize-io/hindsight
  # MCP endpoint: /mcp/{bank_id}/ (per-user memory banks)

  hindsight:
    image: ghcr.io/vectorize-io/hindsight:0.1.10
    expose:
      - "8888"
      - "9999"
    environment:
      # Enable both API and Control Plane (UI)
      - HINDSIGHT_ENABLE_API=true
      - HINDSIGHT_ENABLE_CP=true
      # LLM Configuration (Ollama)
      - HINDSIGHT_API_LLM_PROVIDER=ollama
      - HINDSIGHT_API_LLM_BASE_URL=http://ollama:11434/v1
      - HINDSIGHT_API_LLM_MODEL=${HINDSIGHT_LLM_MODEL:-qwen2.5:7b}
      # Embeddings use built-in local model (384-dim BAAI/bge-small-en-v1.5)
      - HINDSIGHT_API_EMBEDDINGS_PROVIDER=local
      # Server configuration - bind to all interfaces
      - HINDSIGHT_API_HOST=0.0.0.0
      - HINDSIGHT_API_PORT=8888
      - HINDSIGHT_API_LOG_LEVEL=${HINDSIGHT_LOG_LEVEL:-info}
      # Control Plane UI configuration - bind to all interfaces
      - HINDSIGHT_CP_HOST=0.0.0.0
      - HINDSIGHT_CP_PORT=9999
      - HINDSIGHT_CP_DATAPLANE_API_URL=http://0.0.0.0:8888
      # Next.js must bind to all interfaces for Traefik
      - HOSTNAME=0.0.0.0
      - HOST=0.0.0.0
      # Explicitly enable MCP server
      - HINDSIGHT_API_MCP_ENABLED=true
      - HINDSIGHT_API_MCP_HOST=0.0.0.0
    volumes:
      - hindsight_data:/home/hindsight/.pg0
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    depends_on:
      - ollama
    labels:
      - "traefik.enable=true"
      # API - Public Domain (port 8888)
      - "traefik.http.routers.hindsight-api-public.rule=Host(`${HINDSIGHT_API_DOMAIN}`)"
      - "traefik.http.routers.hindsight-api-public.entrypoints=websecure"
      - "traefik.http.routers.hindsight-api-public.tls.certresolver=letsencrypt"
      - "traefik.http.routers.hindsight-api-public.service=hindsight-api"
      # API - Private Domain (port 8888)
      - "traefik.http.routers.hindsight-api-private.rule=Host(`${HINDSIGHT_API_INTERNAL_DOMAIN}`)"
      - "traefik.http.routers.hindsight-api-private.entrypoints=websecure"
      - "traefik.http.routers.hindsight-api-private.tls.certresolver=letsencrypt"
      - "traefik.http.routers.hindsight-api-private.service=hindsight-api"
      # API Service configuration
      - "traefik.http.services.hindsight-api.loadbalancer.server.port=8888"
      # UI - Public Domain (port 9999)
      - "traefik.http.routers.hindsight-ui-public.rule=Host(`${HINDSIGHT_UI_DOMAIN}`)"
      - "traefik.http.routers.hindsight-ui-public.entrypoints=websecure"
      - "traefik.http.routers.hindsight-ui-public.tls.certresolver=letsencrypt"
      - "traefik.http.routers.hindsight-ui-public.service=hindsight-ui"
      # UI - Private Domain (port 9999)
      - "traefik.http.routers.hindsight-ui-private.rule=Host(`${HINDSIGHT_UI_INTERNAL_DOMAIN}`)"
      - "traefik.http.routers.hindsight-ui-private.entrypoints=websecure"
      - "traefik.http.routers.hindsight-ui-private.tls.certresolver=letsencrypt"
      - "traefik.http.routers.hindsight-ui-private.service=hindsight-ui"
      # UI Service configuration
      - "traefik.http.services.hindsight-ui.loadbalancer.server.port=9999"
      - "traefik.docker.network=traefik_public"
    networks:
      - ai-app
      - traefik_public

networks:
  ai-app:
    driver: bridge
  traefik_public:
    external: true
  dmz:
    external: true

volumes:
  whisper_models:
  ollama_data:
  hindsight_data:
