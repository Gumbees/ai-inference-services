services:
  faster-whisper:
    image: onerahmet/openai-whisper-asr-webservice:latest
    expose:
      - "9000"
    environment:
      - ASR_MODEL=base
      - PORT=9000
    volumes:
      - whisper_models:/root/.cache/whisper
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      # Public Domain
      - "traefik.http.routers.whisper-public.rule=Host(`${WHISPER_PUBLIC_DOMAIN}`)"
      - "traefik.http.routers.whisper-public.entrypoints=websecure"
      - "traefik.http.routers.whisper-public.tls.certresolver=letsencrypt"
      # Private Domain
      - "traefik.http.routers.whisper-private.rule=Host(`${WHISPER_PRIVATE_DOMAIN}`)"
      - "traefik.http.routers.whisper-private.entrypoints=websecure"
      - "traefik.http.routers.whisper-private.tls.certresolver=letsencrypt"
      # Service configuration
      - "traefik.http.services.whisper.loadbalancer.server.port=9000"
      - "traefik.docker.network=traefik_public"
    networks:
      ai-app:
      traefik_public:
      dmz:
        ipv4_address: 192.168.73.90


  ollama:
    image: ollama/ollama:rocm
    runtime: amd
    expose:
      - "11434"
    environment:
      - OLLAMA_HOST=0.0.0.0
      - AMD_VISIBLE_DEVICES=all
    volumes:
      - ollama_data:/root/.ollama
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '8'
    labels:
      - "traefik.enable=true"
      # Public Domain
      - "traefik.http.routers.ollama-public.rule=Host(`${OLLAMA_PUBLIC_DOMAIN}`)"
      - "traefik.http.routers.ollama-public.entrypoints=websecure"
      - "traefik.http.routers.ollama-public.tls.certresolver=letsencrypt"
      # Private Domain
      - "traefik.http.routers.ollama-private.rule=Host(`${OLLAMA_PRIVATE_DOMAIN}`)"
      - "traefik.http.routers.ollama-private.entrypoints=websecure"
      - "traefik.http.routers.ollama-private.tls.certresolver=letsencrypt"
      # Service discovery
      - "traefik.http.services.ollama.loadbalancer.server.port=11434"
      - "traefik.docker.network=traefik_public"
    networks:
      - ai-app
      - traefik_public

  # ============================================
  # OpenMemory - AI Memory Layer with UI
  # ============================================
  # Official mem0ai pre-built images with web dashboard
  # Docs: https://docs.mem0.ai/openmemory/overview
  # Supports Ollama via API config after startup

  mem0_store:
    image: qdrant/qdrant:latest
    expose:
      - "6333"
    volumes:
      - openmemory_vectors:/qdrant/storage
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - ai-app

  openmemory-mcp:
    image: mem0/openmemory-mcp:latest
    expose:
      - "8765"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - USER=${OPENMEMORY_USER:-nate}
      # Qdrant connection
      - QDRANT_HOST=mem0_store
      - QDRANT_PORT=6333
    volumes:
      - openmemory_data:/app/data
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    depends_on:
      - mem0_store
      - ollama
    labels:
      - "traefik.enable=true"
      # Public Domain - API/MCP endpoint
      - "traefik.http.routers.openmemory-api-public.rule=Host(`${OPENMEMORY_API_DOMAIN}`)"
      - "traefik.http.routers.openmemory-api-public.entrypoints=websecure"
      - "traefik.http.routers.openmemory-api-public.tls.certresolver=letsencrypt"
      # Private Domain
      - "traefik.http.routers.openmemory-api-private.rule=Host(`${OPENMEMORY_API_INTERNAL_DOMAIN}`)"
      - "traefik.http.routers.openmemory-api-private.entrypoints=websecure"
      - "traefik.http.routers.openmemory-api-private.tls.certresolver=letsencrypt"
      # Service configuration
      - "traefik.http.services.openmemory-api.loadbalancer.server.port=8765"
      - "traefik.docker.network=traefik_public"
    networks:
      - ai-app
      - traefik_public

  openmemory-ui:
    image: mem0/openmemory-ui:latest
    expose:
      - "3000"
    environment:
      # Must be external URL - browser can't reach internal Docker hostnames
      - NEXT_PUBLIC_API_URL=https://${OPENMEMORY_API_INTERNAL_DOMAIN}
      - NEXT_PUBLIC_USER_ID=${OPENMEMORY_USER:-nate}
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    depends_on:
      - openmemory-mcp
    labels:
      - "traefik.enable=true"
      # Public Domain - UI
      - "traefik.http.routers.openmemory-ui-public.rule=Host(`${OPENMEMORY_UI_DOMAIN}`)"
      - "traefik.http.routers.openmemory-ui-public.entrypoints=websecure"
      - "traefik.http.routers.openmemory-ui-public.tls.certresolver=letsencrypt"
      # Private Domain
      - "traefik.http.routers.openmemory-ui-private.rule=Host(`${OPENMEMORY_UI_INTERNAL_DOMAIN}`)"
      - "traefik.http.routers.openmemory-ui-private.entrypoints=websecure"
      - "traefik.http.routers.openmemory-ui-private.tls.certresolver=letsencrypt"
      # Service configuration
      - "traefik.http.services.openmemory-ui.loadbalancer.server.port=3000"
      - "traefik.docker.network=traefik_public"
    networks:
      - ai-app
      - traefik_public

networks:
  ai-app:
    driver: bridge
  traefik_public:
    external: true
  dmz:
    external: true

volumes:
  whisper_models:
  ollama_data:
  openmemory_vectors:
  openmemory_data:
